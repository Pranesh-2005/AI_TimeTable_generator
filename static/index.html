<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Timetable AI Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 2rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9ff;
        }
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #f0f0ff;
        }
        .analysis-result {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .timetable-container {
            overflow-x: auto;
        }
        .loading {
            display: none;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .error-message {
            color: red;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <div class="container">
            <h1><i class="fas fa-robot me-3"></i>Dynamic Timetable AI Generator</h1>
            <p class="lead">Upload your existing timetable CSV or create from scratch with AI</p>
        </div>
    </div>

    <div class="container mt-4">
        <!-- Debug Info -->
        <div id="debugInfo" style="display: none;" class="alert alert-warning">
            <strong>Debug:</strong> <span id="debugText"></span>
        </div>

        <!-- Progress Steps -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="progress" style="height: 3px;">
                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 25%"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">Step 1: Upload/Configure</small>
                    <small class="text-muted">Step 2: Requirements</small>
                    <small class="text-muted">Step 3: Generate</small>
                    <small class="text-muted">Step 4: Results</small>
                </div>
            </div>
        </div>

        <!-- Step 1: Upload or Configure -->
        <div id="step1" class="step active">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-upload me-2"></i>Upload Reference Timetable (Optional)</h5>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>Drag & Drop CSV File</h5>
                                <p class="text-muted">Or click to browse files</p>
                                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('csvFile').click()">
                                    Choose File
                                </button>
                            </div>
                            
                            <div id="fileInfo" style="display: none;" class="mt-3">
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <span id="fileName"></span>
                                    <button type="button" class="btn btn-sm btn-outline-danger float-end" onclick="handleClearFile()">
                                        Remove
                                    </button>
                                </div>
                            </div>

                            <div id="analysisResult" style="display: none;" class="analysis-result">
                                <h6><i class="fas fa-chart-bar me-2"></i>Analysis Results:</h6>
                                <div id="analysisContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cog me-2"></i>Basic Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Institution Name *</label>
                                <input type="text" class="form-control" id="institutionName" 
                                       placeholder="Enter institution name" required>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Department *</label>
                                    <input type="text" class="form-control" id="department" 
                                           placeholder="e.g., Computer Science" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Academic Year *</label>
                                    <input type="text" class="form-control" id="academicYear" 
                                           placeholder="e.g., 2024-25" required>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Year *</label>
                                    <select class="form-control" id="year" required>
                                        <option value="">Select Year</option>
                                        <option value="1">First Year</option>
                                        <option value="2">Second Year</option>
                                        <option value="3">Third Year</option>
                                        <option value="4">Fourth Year</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Semester *</label>
                                    <select class="form-control" id="semester" required>
                                        <option value="">Select Semester</option>
                                        <option value="ODD">ODD Semester</option>
                                        <option value="EVEN">EVEN Semester</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Start Date *</label>
                                    <input type="date" class="form-control" id="startDate" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">End Date *</label>
                                    <input type="date" class="form-control" id="endDate" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Working Days *</label>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="monday" value="Monday" checked>
                                            <label class="form-check-label" for="monday">Mon</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="tuesday" value="Tuesday" checked>
                                            <label class="form-check-label" for="tuesday">Tue</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="wednesday" value="Wednesday" checked>
                                            <label class="form-check-label" for="wednesday">Wed</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="thursday" value="Thursday" checked>
                                            <label class="form-check-label" for="thursday">Thu</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="friday" value="Friday" checked>
                                            <label class="form-check-label" for="friday">Fri</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="saturday" value="Saturday">
                                            <label class="form-check-label" for="saturday">Sat</label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-end">
                                <button type="button" class="btn btn-primary" onclick="handleNextStep(2)">
                                    Next: Define Requirements <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Requirements -->
        <div id="step2" class="step">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list-ul me-2"></i>Timetable Requirements & Constraints</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <h6>Academic Requirements</h6>
                            <div class="mb-3">
                                <label class="form-label">Total Periods per Day</label>
                                <input type="number" class="form-control" id="periodsPerDay" value="8" min="4" max="12">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Theory Sessions per Week</label>
                                <input type="number" class="form-control" id="theorySessionsPerWeek" value="20" min="10" max="40">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lab Sessions per Week</label>
                                <input type="number" class="form-control" id="labSessionsPerWeek" value="6" min="2" max="15">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Elective Sessions per Week</label>
                                <input type="number" class="form-control" id="electiveSessionsPerWeek" value="4" min="0" max="10">
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <h6>Scheduling Constraints</h6>
                            <div class="mb-3">
                                <label class="form-label">Break Duration (minutes)</label>
                                <input type="number" class="form-control" id="breakDuration" value="15" min="10" max="30">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Lunch Break Duration (minutes)</label>
                                <input type="number" class="form-control" id="lunchBreakDuration" value="60" min="30" max="90">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Preferred Lab Duration (hours)</label>
                                <input type="number" class="form-control" id="labDuration" value="3" min="2" max="4">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Maximum Consecutive Classes</label>
                                <input type="number" class="form-control" id="maxConsecutive" value="3" min="2" max="5">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Additional Requirements</label>
                        <textarea class="form-control" id="additionalRequirements" rows="3" 
                                  placeholder="Enter any specific requirements, constraints, or preferences..."></textarea>
                    </div>

                    <div class="text-end">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="handlePrevStep(1)">
                            <i class="fas fa-arrow-left me-2"></i>Previous
                        </button>
                        <button type="button" class="btn btn-primary" onclick="handleNextStep(3)">
                            Next: Generate Timetable <i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Generate -->
        <div id="step3" class="step">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-magic me-2"></i>Generate Timetable</h5>
                </div>
                <div class="card-body text-center">
                    <div id="generateContent">
                        <i class="fas fa-robot fa-4x text-primary mb-4"></i>
                        <h4>Ready to Generate Your Timetable</h4>
                        <p class="text-muted mb-4">Our AI will analyze your requirements and create an optimized timetable</p>
                        
                        <button type="button" class="btn btn-primary btn-lg" onclick="handleGenerateTimetable()">
                            <i class="fas fa-magic me-2"></i>Generate AI Timetable
                        </button>
                    </div>

                    <div id="generatingContent" class="loading">
                        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                        <h5>Generating Your Timetable...</h5>
                        <p class="text-muted">This may take a few moments</p>
                    </div>

                    <div class="text-end mt-4">
                        <button type="button" class="btn btn-outline-secondary" onclick="handlePrevStep(2)">
                            <i class="fas fa-arrow-left me-2"></i>Previous
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Results -->
        <div id="step4" class="step">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-table me-2"></i>Generated Timetable</h5>
                    <div>
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="handleExportTimetable()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="handleStartOver()">
                            <i class="fas fa-redo me-1"></i>Start Over
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="timetableContent">
                        <!-- Generated timetable will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Bootstrap JS first -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/bootstrap.bundle.min.js"></script>

    <!-- Main Application Script -->
    <script>
        console.log('Loading main app script...');

// Global variables
const API_BASE_URL = 'https://ai-timetable-generator.onrender.com';
let uploadedFile = null;
let analysisData = null;
let currentStep = 1;

// Initialize app when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing app...');
    initializeApp();
});

function initializeApp() {
    console.log('App initialized');
    
    // Set default dates
    const today = new Date();
    const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, today.getDate());
    
    document.getElementById('startDate').value = today.toISOString().split('T')[0];
    document.getElementById('endDate').value = nextMonth.toISOString().split('T')[0];
    
    // Setup file upload
    setupFileUpload();
}

function setupFileUpload() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('csvFile');
    
    // Click to upload
    uploadArea.addEventListener('click', () => fileInput.click());
    
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files[0]);
        }
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileUpload(e.target.files[0]);
        }
    });
}

async function handleFileUpload(file) {
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please upload a CSV file');
        return;
    }
    
    uploadedFile = file;
    
    // Show file info
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileInfo').style.display = 'block';
    
    // Analyze file
    await analyzeUploadedFile(file);
}

async function analyzeUploadedFile(file) {
    try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetch(`${API_BASE_URL}/analyze-csv`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            analysisData = result.analysis;
            displayAnalysisResults(result.analysis);
            autoPopulateFromAnalysis(result.analysis);
        } else {
            alert('Error analyzing file: ' + result.message);
        }
    } catch (error) {
        console.error('Error analyzing file:', error);
        alert('Error analyzing file. Please try again.');
    }
}

function displayAnalysisResults(analysis) {
    const content = document.getElementById('analysisContent');
    
    let html = '<div class="row">';
    
    // Subjects found
    if (analysis.subjects && analysis.subjects.length > 0) {
        html += `<div class="col-md-6">
            <strong>Subjects Found (${analysis.subjects.length}):</strong>
            <ul class="list-unstyled mt-1">`;
        analysis.subjects.slice(0, 5).forEach(subject => {
            html += `<li><small class="badge bg-primary me-1">${subject}</small></li>`;
        });
        if (analysis.subjects.length > 5) {
            html += `<li><small class="text-muted">+${analysis.subjects.length - 5} more...</small></li>`;
        }
        html += '</ul></div>';
    }
    
    // Faculty found
    if (analysis.faculty && analysis.faculty.length > 0) {
        html += `<div class="col-md-6">
            <strong>Faculty Found (${analysis.faculty.length}):</strong>
            <ul class="list-unstyled mt-1">`;
        analysis.faculty.slice(0, 3).forEach(faculty => {
            html += `<li><small class="badge bg-success me-1">${faculty}</small></li>`;
        });
        if (analysis.faculty.length > 3) {
            html += `<li><small class="text-muted">+${analysis.faculty.length - 3} more...</small></li>`;
        }
        html += '</ul></div>';
    }
    
    html += '</div>';
    
    // Structure info
    if (analysis.structure_type) {
        html += `<div class="mt-2">
            <strong>Structure Type:</strong> 
            <span class="badge bg-info">${analysis.structure_type.replace('_', ' ')}</span>
        </div>`;
    }
    
    content.innerHTML = html;
    document.getElementById('analysisResult').style.display = 'block';
}

function autoPopulateFromAnalysis(analysis) {
    // Auto-populate institution name if found in metadata
    for (const [key, value] of Object.entries(analysis.metadata || {})) {
        if (key.toLowerCase().includes('institution') || value.toLowerCase().includes('institute')) {
            document.getElementById('institutionName').value = value;
            break;
        }
    }
    
    // Auto-populate department if found
    for (const [key, value] of Object.entries(analysis.metadata || {})) {
        if (key.toLowerCase().includes('department') || value.toLowerCase().includes('dept')) {
            document.getElementById('department').value = value;
            break;
        }
    }
}

function nextStep(step) {
    console.log(`Moving to step ${step}`);
    if (validateCurrentStep()) {
        currentStep = step;
        showStep(step);
        updateProgress();
    }
}

function prevStep(step) {
    console.log(`Moving back to step ${step}`);
    currentStep = step;
    showStep(step);
    updateProgress();
}

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    
    // Show current step
    document.getElementById(`step${step}`).classList.add('active');
}

function updateProgress() {
    const progress = (currentStep / 4) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;
}

function validateCurrentStep() {
    if (currentStep === 1) {
        // Validate basic configuration
        const required = ['institutionName', 'department', 'academicYear', 'year', 'semester', 'startDate', 'endDate'];
        for (const field of required) {
            const element = document.getElementById(field);
            if (!element || !element.value) {
                alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
                return false;
            }
        }
        
        // Check working days
        const workingDays = getWorkingDays();
        if (workingDays.length === 0) {
            alert('Please select at least one working day');
            return false;
        }
    }
    
    return true;
}

function getWorkingDays() {
    const days = [];
    ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'].forEach(day => {
        const element = document.getElementById(day);
        if (element && element.checked) {
            days.push(element.value);
        }
    });
    return days;
}

function getRequirements() {
    return {
        periods_per_day: parseInt(document.getElementById('periodsPerDay').value) || 8,
        theory_sessions_per_week: parseInt(document.getElementById('theorySessionsPerWeek').value) || 20,
        lab_sessions_per_week: parseInt(document.getElementById('labSessionsPerWeek').value) || 6,
        elective_sessions_per_week: parseInt(document.getElementById('electiveSessionsPerWeek').value) || 4,
        additional_requirements: document.getElementById('additionalRequirements').value || ''
    };
}

function getConstraints() {
    return {
        break_duration: parseInt(document.getElementById('breakDuration').value) || 15,
        lunch_break_duration: parseInt(document.getElementById('lunchBreakDuration').value) || 60,
        lab_duration: parseInt(document.getElementById('labDuration').value) || 3,
        max_consecutive_classes: parseInt(document.getElementById('maxConsecutive').value) || 3
    };
}

async function generateTimetable() {
    console.log('Generating timetable...');
    
    // Show loading
    document.getElementById('generateContent').style.display = 'none';
    document.getElementById('generatingContent').style.display = 'block';
    
    try {
        const requestData = {
            institution_name: document.getElementById('institutionName').value,
            department: document.getElementById('department').value,
            year: parseInt(document.getElementById('year').value),
            semester: document.getElementById('semester').value,
            academic_year: document.getElementById('academicYear').value,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            working_days: getWorkingDays(),
            requirements: getRequirements(),
            constraints: getConstraints()
        };
        
        console.log('Request data:', requestData);
        
        // Create form data
        const formData = new FormData();
        
        // Add all request data as JSON strings for complex objects
        Object.keys(requestData).forEach(key => {
            if (typeof requestData[key] === 'object') {
                formData.append(key, JSON.stringify(requestData[key]));
            } else {
                formData.append(key, requestData[key]);
            }
        });
        
        // Add reference file if uploaded
        if (uploadedFile) {
            formData.append('reference_file', uploadedFile);
        }
        
        const response = await fetch(`${API_BASE_URL}/generate-dynamic-timetable`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        console.log('Response:', result);
        
        // ENHANCED ERROR CHECKING: Check what the backend actually returned
        if (result.success) {
            console.log('=== BACKEND ANALYSIS ===');
            console.log('Timetable object:', result.timetable);
            console.log('Timetable type:', typeof result.timetable);
            console.log('Timetable keys:', Object.keys(result.timetable || {}));
            
            // Check if backend returned placeholder message
            if (result.timetable && result.timetable.message) {
                showDebug(`⚠️ Backend Issue: ${result.timetable.message}`);
                displayBackendError(result.timetable.message);
                return;
            }
            
            // Check for valid timetable structure
            const timetable = result.timetable?.timetable || result.timetable;
            
            if (timetable && typeof timetable === 'object' && !timetable.message) {
                // Check if it has day-wise data
                const days = Object.keys(timetable);
                const hasValidDays = days.some(day => 
                    ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].includes(day)
                );
                
                if (hasValidDays) {
                    console.log('✅ Valid timetable data received');
                    displayTimetable(result.timetable);
                    nextStep(4);
                } else {
                    console.error('❌ Invalid timetable structure - no valid days found');
                    showDebug('Invalid timetable structure - no days found');
                    displayBackendError('Backend returned invalid timetable structure');
                }
            } else {
                console.error('❌ No valid timetable data in response');
                showDebug('No valid timetable data in response');
                displayBackendError('No valid timetable data received from backend');
            }
        } else {
            console.error('❌ Backend returned error');
            alert('Error generating timetable: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('❌ API call failed:', error);
        alert('Error connecting to server. Please try again.');
    } finally {
        // Hide loading
        document.getElementById('generateContent').style.display = 'block';
        document.getElementById('generatingContent').style.display = 'none';
    }
}

function displayBackendError(message) {
    const container = document.getElementById('timetableContent');
    container.innerHTML = `
        <div class="alert alert-warning">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>Backend Development Notice</h5>
            <p><strong>Issue:</strong> ${message}</p>
            <hr>
            <h6>For Backend Developer:</h6>
            <p>The backend endpoint <code>/generate-dynamic-timetable</code> needs to be implemented to return actual timetable data instead of placeholder messages.</p>
            <p><strong>Expected Response Structure:</strong></p>
            <pre class="bg-light p-2 rounded"><code>{
  "success": true,
  "message": "Timetable generated successfully",
  "timetable": {
    "timetable": {
      "Monday": {
        "Period_1": {
          "subject_code": "CS101",
          "subject": "Computer Science",
          "faculty": "Dr. Smith",
          "room": "Room 101",
          "type": "Theory",
          "time": "09:00-10:00"
        },
        // ... more periods
      },
      // ... more days
    },
    "summary": { /* stats */ },
    "recommendations": [ /* suggestions */ ]
  }
}</code></pre>
        </div>
    `;
    nextStep(4); // Still show the results step to display the error
}

function displayTimetable(timetableData) {
    const container = document.getElementById('timetableContent');
    
    console.log('=== DISPLAYING TIMETABLE ===');
    console.log('Timetable data received:', timetableData);
    
    if (!timetableData) {
        container.innerHTML = '<div class="alert alert-warning">No timetable data received.</div>';
        return;
    }
    
    // Handle the structure from your backend
    const timetable = timetableData.timetable || timetableData;
    const summary = timetableData.summary;
    const recommendations = timetableData.recommendations;
    const requestDetails = timetableData.request_details;
    
    if (!timetable || typeof timetable !== 'object' || Object.keys(timetable).length === 0) {
        container.innerHTML = '<div class="alert alert-warning">Invalid timetable format received.</div>';
        return;
    }
    
    let html = '<div class="timetable-container">';
    html += '<table class="table table-bordered table-striped table-hover">';
    
    // Get all time slots from the first day to create header
    const firstDay = Object.keys(timetable)[0];
    const timeSlots = firstDay ? Object.keys(timetable[firstDay]) : [];
    
    if (timeSlots.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No time slots found in timetable.</div>';
        return;
    }
    
    // Create header row
    html += '<thead class="table-dark"><tr>';
    html += '<th class="text-center" style="min-width: 100px;">Day</th>';
    
    timeSlots.forEach(slot => {
        const slotName = slot.replace(/Period_(\d+)/, 'Period $1').replace(/_/g, ' ');
        html += `<th class="text-center" style="min-width: 150px;">${slotName}</th>`;
    });
    html += '</tr></thead>';
    
    // Create body rows
    html += '<tbody>';
    Object.entries(timetable).forEach(([day, periods]) => {
        html += `<tr>`;
        html += `<td class="fw-bold bg-light text-center align-middle">${day}</td>`;
        
        timeSlots.forEach(slot => {
            const period = periods[slot];
            html += '<td class="text-center align-middle" style="padding: 8px; min-height: 80px;">';
            
            if (period && typeof period === 'object') {
                if (period.type === 'break' || period.type === 'lunch') {
                    html += `<div class="p-2 bg-light rounded border">
                        <strong class="text-secondary d-block">${period.subject}</strong>
                        <small class="text-muted">${period.time || ''}</small>
                    </div>`;
                } else if (period.type === 'free') {
                    html += `<div class="p-2 bg-light rounded border text-muted">
                        <small class="d-block">Free Period</small>
                        <small>${period.time || ''}</small>
                    </div>`;
                } else {
                    // Regular class period
                    const subjectCode = period.subject_code || '';
                    const subjectName = period.subject || '';
                    const faculty = period.faculty || '';
                    const room = period.room || '';
                    const type = period.type || '';
                    const time = period.time || '';
                    const duration = period.duration || '';
                    
                    html += `<div class="p-2 border rounded" style="background: #f8f9fa;">`;
                    
                    if (subjectCode) {
                        html += `<strong class="text-primary d-block" style="font-size: 0.9rem;">${subjectCode}</strong>`;
                    }
                    
                    if (subjectName && subjectName !== subjectCode) {
                        html += `<small class="text-dark d-block" style="font-size: 0.8rem;">${subjectName}</small>`;
                    }
                    
                    if (time) {
                        html += `<small class="text-muted d-block" style="font-size: 0.75rem;">${time}</small>`;
                    }
                    
                    if (faculty) {
                        html += `<small class="text-success d-block" style="font-size: 0.75rem;">${faculty}</small>`;
                    }
                    
                    if (room || type || duration) {
                        html += '<div class="mt-1">';
                        if (room) {
                            html += `<span class="badge bg-secondary me-1" style="font-size: 0.6rem;">${room}</span>`;
                        }
                        if (type) {
                            html += `<span class="badge bg-info me-1" style="font-size: 0.6rem;">${type}</span>`;
                        }
                        if (duration) {
                            html += `<br><small class="text-muted" style="font-size: 0.6rem;">${duration}</small>`;
                        }
                        html += '</div>';
                    }
                    
                    html += '</div>';
                }
            } else if (period && typeof period === 'string') {
                html += `<small class="text-muted">${period}</small>`;
            } else {
                html += '<small class="text-muted">-</small>';
            }
            
            html += '</td>';
        });
        html += '</tr>';
    });
    html += '</tbody></table></div>';
    
    // Add summary section
    if (summary) {
        html += '<div class="row mt-4">';
        html += '<div class="col-md-6">';
        html += '<div class="card">';
        html += '<div class="card-header"><h6><i class="fas fa-chart-bar me-2"></i>Timetable Summary</h6></div>';
        html += '<div class="card-body">';
        html += '<div class="row">';
        
        Object.entries(summary).forEach(([key, value]) => {
            const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<div class="col-12 mb-2">
                <strong class="text-primary">${displayKey}:</strong> 
                <span class="text-dark">${value}</span>
            </div>`;
        });
        
        html += '</div></div></div></div>';
        
        // Add recommendations
        if (recommendations && recommendations.length > 0) {
            html += '<div class="col-md-6">';
            html += '<div class="card">';
            html += '<div class="card-header"><h6><i class="fas fa-lightbulb me-2"></i>Recommendations</h6></div>';
            html += '<div class="card-body">';
            html += '<ul class="mb-0">';
            recommendations.forEach(rec => {
                html += `<li class="mb-2 text-muted">${rec}</li>`;
            });
            html += '</ul></div></div></div>';
        }
        
        html += '</div>';
    }
    
    // Add request details if available
    if (requestDetails) {
        html += '<div class="mt-3">';
        html += '<div class="card">';
        html += '<div class="card-header"><h6><i class="fas fa-info-circle me-2"></i>Generation Details</h6></div>';
        html += '<div class="card-body">';
        html += '<div class="row">';
        
        Object.entries(requestDetails).forEach(([key, value]) => {
            const displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<div class="col-md-4 mb-2">
                <strong class="text-primary">${displayKey}:</strong><br>
                <span class="text-muted">${value}</span>
            </div>`;
        });
        
        html += '</div></div></div></div>';
    }
    
    container.innerHTML = html;
    console.log('✅ Timetable displayed successfully');
}

function clearFile() {
    uploadedFile = null;
    analysisData = null;
    document.getElementById('fileInfo').style.display = 'none';
    document.getElementById('analysisResult').style.display = 'none';
    document.getElementById('csvFile').value = '';
}

function exportTimetable() {
    const content = document.getElementById('timetableContent').innerHTML;
    const institutionName = document.getElementById('institutionName').value;
    const department = document.getElementById('department').value;
    
    const newWindow = window.open('', '_blank');
    newWindow.document.write(`
        <html>
        <head>
            <title>Timetable - ${institutionName} - ${department}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/bootstrap.min.css" rel="stylesheet">
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 2rem; }
                table { font-size: 12px; width: 100%; }
                th, td { padding: 8px; border: 1px solid #ddd; }
                @media print {
                     .no-print { display: none; }
                    body { margin: 0; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>${institutionName}</h2>
                <h4>Department of ${department}</h4>
                <p>Academic Year: ${document.getElementById('academicYear').value}</p>
                <p>Generated on: ${new Date().toLocaleDateString()}</p>
            </div>
            ${content}
            <div class="no-print mt-4 text-center">
                <button onclick="window.print()" class="btn btn-primary">Print</button>
                <button onclick="window.close()" class="btn btn-secondary">Close</button>
            </div>
        </body>
        </html>
    `);
    newWindow.document.close();
}

function startOver() {
    if (confirm('Are you sure you want to start over? All current data will be lost.')) {
        location.reload();
    }
}

// Handler functions that call the main functions
function handleNextStep(step) {
    console.log('handleNextStep called with step:', step);
    nextStep(step);
}

function handlePrevStep(step) {
    console.log('handlePrevStep called with step:', step);
    prevStep(step);
}

function handleGenerateTimetable() {
    console.log('handleGenerateTimetable called');
    generateTimetable();
}

function handleExportTimetable() {
    exportTimetable();
}

function handleStartOver() {
    startOver();
}

function handleClearFile() {
    clearFile();
}

// Global error handler
window.addEventListener('error', function(e) {
    console.error('JavaScript Error:', e.error);
    showDebug('JavaScript Error: ' + e.error);
});

function showDebug(message) {
    document.getElementById('debugText').textContent = message;
    document.getElementById('debugInfo').style.display = 'block';
}

console.log('Script loaded successfully');
    </script>
</body>
</html>